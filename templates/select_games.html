<!--
select_games.html

Allows users to browse and select NBA games they enjoyed from the current season.
Fetches games by date from the backend, displays them as interactive cards with team logos, 
scores, and metadata. Users can select/unselect games via checkboxes, with selections 
stored in localStorage for use in later recommendation steps. Includes a link to view 
currently selected games and a button to proceed to the next step in the flow.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NBA Game Selector</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

  <style>
    .main-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin: 0 auto;
    }
    body {
      background-color: #1a1a1a;
      font-family: 'Bebas Neue', sans-serif;
      margin: 20px;
      font-size: 20px;
    }

    h2 {
      font-size: 32px;
      letter-spacing: 1px;
      color: #ff4500;
    }

    #games {
      margin-top: 20px;
    }

    .game-card {
      border: 1px solid #9f5233;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      background-color: #fff6f2;
    }

    .game-header {
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .team-logo {
      width: 75px;
      height: 75px;
      object-fit: contain;
    }

    .game-title {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
      line-height: 1.2;
    }

    .game-meta {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-top: 8px;
    }

    .game-card:hover {
      transform: scale(1.05);
    }

    .game-score {
      font-size: 18px;
      font-weight: bold;
      color: black;
      margin-top: 2px;
    }


    #dateInput {
      margin-bottom: 12px; /* adds space below calendar */
    }

    button {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px;       /* makes the button bigger */
      padding: 10px 18px;    /* enlarges clickable area */
    }

    .done-button {
      margin-top: 30px;
      padding: 10px 15px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    } 

    .message-text {
      color: #d3590d;  /* Use the same orange as the header */
      font-weight: bold;
    }

    .see-button {
      margin-top: 20px;
      padding: 10px 18px;
      font-size: 20px;
      background-color: #ff9500;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .see-button:hover { background-color: #ffa733; }

    /* modal shell */
    .modal {
      display: none;               /* keep hidden until opened   */
      position: fixed;
      z-index: 1000;
      inset: 0;                    /* shorthand for top/left‚Ä¶0   */
      background: rgba(0,0,0,0.6); /* dark overlay               */
      overflow-y: auto;
    }
    /* modal box */
    .modal-content {
      background: #fff6f2;
      margin: 60px auto;
      padding: 25px 25px 35px;
      max-width: 680px;
      border-radius: 8px;
    }
    .modal-content h3 { margin-top: 0; text-align: center; }
    /* close -√ó- icon */
    .modal .close {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="main-content">  
    <!-- Page title & date selector -->
    <h2>Select Games You Liked From The Current Season üîç </h2>
    <input type="date" id="dateInput">

    <!-- Loading status text -->
    <div id="loading" class="message-text" style="display:none;">Loading. ‚åõ</div>
    <!-- Container for dynamically generated game cards -->
    <div id="games"></div>
    <!-- Action buttons -->
    <button class="done-button" onclick="goToNextPage()">‚úÖ Done Selecting</button>
    <button id="seeMyGamesBtn" class="see-button">üëÄ See My Games</button>

  </div>  

  <script> 
    // --- Local state & persistent storage ---
    const selectedGameIds   = new Set(JSON.parse(localStorage.getItem("selectedGameIds") || "[]"));
    const selectedGamesInfo = JSON.parse(localStorage.getItem("selectedGamesInfo") || "{}");
  
    // Team logo mapping for card display
    const teamLogos = {
      "Atlanta Hawks": "https://cdn.nba.com/logos/nba/1610612737/global/L/logo.svg",
      "Boston Celtics": "https://cdn.nba.com/logos/nba/1610612738/global/L/logo.svg",
      "Brooklyn Nets": "https://cdn.nba.com/logos/nba/1610612751/global/L/logo.svg",
      "Charlotte Hornets": "https://cdn.nba.com/logos/nba/1610612766/global/L/logo.svg",
      "Chicago Bulls": "https://cdn.nba.com/logos/nba/1610612741/global/L/logo.svg",
      "Cleveland Cavaliers": "https://cdn.nba.com/logos/nba/1610612739/global/L/logo.svg",
      "Dallas Mavericks": "https://cdn.nba.com/logos/nba/1610612742/global/L/logo.svg",
      "Denver Nuggets": "https://cdn.nba.com/logos/nba/1610612743/global/L/logo.svg",
      "Detroit Pistons": "https://cdn.nba.com/logos/nba/1610612765/global/L/logo.svg",
      "Golden State Warriors": "https://cdn.nba.com/logos/nba/1610612744/global/L/logo.svg",
      "Houston Rockets": "https://cdn.nba.com/logos/nba/1610612745/global/L/logo.svg",
      "Indiana Pacers": "https://cdn.nba.com/logos/nba/1610612754/global/L/logo.svg",
      "LA Clippers": "https://cdn.nba.com/logos/nba/1610612746/global/L/logo.svg",
      "Los Angeles Lakers": "https://cdn.nba.com/logos/nba/1610612747/global/L/logo.svg",
      "Memphis Grizzlies": "https://cdn.nba.com/logos/nba/1610612763/global/L/logo.svg",
      "Miami Heat": "https://cdn.nba.com/logos/nba/1610612748/global/L/logo.svg",
      "Milwaukee Bucks": "https://cdn.nba.com/logos/nba/1610612749/global/L/logo.svg",
      "Minnesota Timberwolves": "https://cdn.nba.com/logos/nba/1610612750/global/L/logo.svg",
      "New Orleans Pelicans": "https://cdn.nba.com/logos/nba/1610612740/global/L/logo.svg",
      "New York Knicks": "https://cdn.nba.com/logos/nba/1610612752/global/L/logo.svg",
      "Oklahoma City Thunder": "https://cdn.nba.com/logos/nba/1610612760/global/L/logo.svg",
      "Orlando Magic": "https://cdn.nba.com/logos/nba/1610612753/global/L/logo.svg",
      "Philadelphia 76ers": "https://cdn.nba.com/logos/nba/1610612755/global/L/logo.svg",
      "Phoenix Suns": "https://cdn.nba.com/logos/nba/1610612756/global/L/logo.svg",
      "Portland Trail Blazers": "https://cdn.nba.com/logos/nba/1610612757/global/L/logo.svg",
      "Sacramento Kings": "https://cdn.nba.com/logos/nba/1610612758/global/L/logo.svg",
      "San Antonio Spurs": "https://cdn.nba.com/logos/nba/1610612759/global/L/logo.svg",
      "Toronto Raptors": "https://cdn.nba.com/logos/nba/1610612761/global/L/logo.svg",
      "Utah Jazz": "https://cdn.nba.com/logos/nba/1610612762/global/L/logo.svg",
      "Washington Wizards": "https://cdn.nba.com/logos/nba/1610612764/global/L/logo.svg"
    };
  localStorage.setItem("teamLogos", JSON.stringify(teamLogos));
  
  // Convert date object/string to YYYY-MM-DD format  
  function formatDateToYYYYMMDD(date) {
    const d = new Date(date);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  // Fetch games for the selected date from backend
  function fetchGames() {
    const date = document.getElementById('dateInput').value;
    if (!date) {
      alert("Please select a date.");
      return;
    }

    const formattedDate = formatDateToYYYYMMDD(date);
    const loadingDiv = document.getElementById("loading");
    const gamesDiv = document.getElementById("games");

    loadingDiv.style.display = "block";
    gamesDiv.innerHTML = "";

    fetch(`/api/games_by_date?date=${formattedDate}`)
      .then(response => response.json())
      .then(data => {
        loadingDiv.style.display = "none";

        if (data.error) {
          gamesDiv.innerHTML = `<p style="color:red;">${data.error}</p>`;
          return;
        }

        if (data.games.length === 0) {
          gamesDiv.innerHTML = "<p class='message-text'>No games found for this date.</p>";
          return;
        }
        
        // Render each game card
        data.games.forEach(game => {
          const { game_id, away_team, home_team, location, hour, away_score, home_score } = game;

          const card = document.createElement("div");
          card.className = "game-card";
          
          // --- Team logos ---
          const logo1 = document.createElement("img");
          logo1.className = "team-logo";
          logo1.src = teamLogos[away_team] || "";
          logo1.alt = away_team;

          const logo2 = document.createElement("img");
          logo2.className = "team-logo";
          logo2.src = teamLogos[home_team] || "";
          logo2.alt = home_team;

          // --- Header with teams & score ---
          const header = document.createElement("div");
          header.className = "game-header";

          const title = document.createElement("div");
          title.className = "game-title";
          title.innerHTML = `<div>${away_team} vs ${home_team}</div>
            <div class="game-score">${away_score} : ${home_score}</div>`;

          header.appendChild(logo1);
          header.appendChild(title);
          header.appendChild(logo2);
          card.appendChild(header);

          // --- Game metadata (date, location, time) ---
          const meta = document.createElement("div");
          meta.className = "game-meta";
          meta.innerText = `${date} - ${location} - ${hour}`;
          card.appendChild(meta);

          // --- Selection checkbox ---
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.name = "liked_games";
          checkbox.value = game_id;

          const gameWithDate = { ...game, date };
          
          if (selectedGameIds.has(game_id)) {
            checkbox.checked = true;
            selectedGamesInfo[game_id] = gameWithDate;       // ensure info present on reload
            card.style.backgroundColor = "#cce5ff"; // light blue
          }

          // Handle checkbox toggle
          checkbox.onchange = () => {
            if (checkbox.checked) {
              selectedGameIds.add(game_id);
              selectedGamesInfo[game_id] = gameWithDate;    // store full info
              card.style.backgroundColor = "#cce5ff";
            } else {
              selectedGameIds.delete(game_id);
              delete selectedGamesInfo[game_id];    // remove info
              card.style.backgroundColor = "#fff6f2";
            }
            // Save state to localStorage
            localStorage.setItem("selectedGameIds", JSON.stringify(Array.from(selectedGameIds)));
            localStorage.setItem("selectedGamesInfo", JSON.stringify(selectedGamesInfo));
            console.log("Selected Game IDs:", Array.from(selectedGameIds));
          };

          card.appendChild(checkbox);
          gamesDiv.appendChild(card);
        });
      })
      .catch(error => {
        loadingDiv.style.display = "none";
        gamesDiv.innerHTML = `<p style="color:red;">Error: ${error}</p>`;
      });
  }

  // Automatically load games when date is selected
  document.getElementById('dateInput').addEventListener('change', () => {
    fetchGames();
  });
  
  // Open selected games view
  document.getElementById("seeMyGamesBtn")
        .addEventListener("click", () =>
            window.open("/my-games", "myGames",
                        "width=820,height=640,noopener")
  );
    
  // Keep UI synced across tabs/windows
  window.addEventListener("storage", (e) => {
    if (e.key !== "selectedGameIds") return;         // ignore other keys
  
    selectedGameIds.clear();
    (JSON.parse(e.newValue || "[]")).forEach(id => selectedGameIds.add(id));
  
    // Update checkboxes & card highlights
    document.querySelectorAll('input[name="liked_games"]').forEach(cb => {
      const card = cb.parentElement;                 // .game-card
      if (selectedGameIds.has(cb.value)) {
        cb.checked = true;
        card.style.backgroundColor = "#cce5ff";      // light blue (selected)
      } else {
        cb.checked = false;
        card.style.backgroundColor = "#fff6f2";      // default
        }
      });
  });

  // Proceed to next step (select_range)
  function goToNextPage() {
    localStorage.setItem("selectedGameIds", JSON.stringify(Array.from(selectedGameIds)));
    localStorage.setItem("selectedGamesInfo", JSON.stringify(selectedGamesInfo));
    window.location.href = "/select-range";
  }
  
  function cacheGameInfo(gameObj) {
    selectedGamesInfo[gameObj.game_id] = gameObj;
    localStorage.setItem("selectedGamesInfo", JSON.stringify(selectedGamesInfo));
  }
  function uncacheGameInfo(game_id) {
    delete selectedGamesInfo[game_id];
    localStorage.setItem("selectedGamesInfo", JSON.stringify(selectedGamesInfo));
  }

  </script>
</body>
</html>

