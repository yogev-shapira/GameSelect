<!--
select_range.html

Step 2 of the GameSelect flow.
Allows the user to choose:
1. How many recent days to consider for recommendations.
2. How many games to recommend.

Selections are used to send a request to the backend recommender API,
which returns a list of games based on the user's previously liked games.
Results are stored in localStorage and the user is redirected to the results page.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Select Game Range</title>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Anton', sans-serif;
      background-color: #1a1a1a;
      color: #222;
      text-align: center;
      padding: 2rem;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 2rem;
      color: #ff4500;
    }

    .section {
      margin: 2rem 0;
    }

    select {
      font-size: 1.1rem;
      padding: 0.5rem;
      margin-top: 1rem;
    }

    .display {
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #3399ff; /* bright readable blue */
    }

    button {
      padding: 1rem 2rem;
      font-size: 1.2rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #recommendBtn {
      background-color: #a44807;
      color: teal;
      margin-top: 1.5rem;
    }

    #recommendBtn:hover {
      background-color: #d77a2d;
    }

    #goBackBtn {
      background-color: #1b8884;
      color: #222;
      margin-top: 1.5rem;
    }

    #goBackBtn:hover {
      background-color: #21669f;
    }

    p, label {
      color: #ff4500;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 2rem;
      }

      .display {
        font-size: 1rem;
      }

      button {
        font-size: 1rem;
        padding: 0.8rem 1.5rem;
      }
    }
  </style>
</head>
<body>
  <h1>Select Recommendation Range üëá</h1>
  
  <!-- Days range selection -->
  <div class="section">
    <label for="daySelect">Choose how many recent days to include:</label><br />
    <select id="daySelect">
      <option value="" selected disabled>Select days...</option>
    </select>
    <div class="display" id="dateRangeDisplay" style="display: none;"></div>
  </div>

  <!-- Number of games to recommend -->
  <div class="section">
    <label for="gameSelect">Choose how many games to recommend:</label><br />
    <select id="gameSelect">
      <option value="" selected disabled>Select games...</option>
    </select>
    <div class="display" id="gameCountDisplay" style="display: none;"></div>
  </div>

  <!-- Navigation buttons -->
  <div class="section">
    <button id="goBackBtn" onclick="window.location.href='/select-games'">
      ‚¨ÖÔ∏è Back to Choose Favorites
    </button>
  </div>

  <div class="section">
    <button id="recommendBtn">Recommend Games ‚û°Ô∏è</button>
  </div>

  <script>
    // --- DOM element references ---
    const daySelect = document.getElementById("daySelect");
    const gameSelect = document.getElementById("gameSelect");
    
    // Populate day range dropdown (1‚Äì90 days) 
    // i choose 90 days because the season have already ended so you may still see recommendation results
    for (let i = 1; i <= 90; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      daySelect.appendChild(opt);
    }

    // Populate number of games dropdown (1‚Äì20 games)
    for (let i = 1; i <= 20; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      gameSelect.appendChild(opt);
    }

    const today = new Date();
    const dateRangeDisplay = document.getElementById("dateRangeDisplay");
    const gameCountDisplay = document.getElementById("gameCountDisplay");

    // Show the date range when user selects number of days
    daySelect.addEventListener("change", () => {
      const numDays = parseInt(daySelect.value);
      const startDate = new Date(today);
      startDate.setDate(today.getDate() - numDays);

      const formatDate = (date) =>
        `${date.getDate()}.${date.getMonth() + 1}.${String(date.getFullYear()).slice(2)}`;

      dateRangeDisplay.textContent = `Selected Date Range: ${formatDate(startDate)} ‚Äì ${formatDate(today)}`;
      dateRangeDisplay.style.display = "block";
    });
  
    // Show number of games selected
    gameSelect.addEventListener("change", () => {
      gameCountDisplay.textContent = `Number of Games to Recommend: ${gameSelect.value}`;
      gameCountDisplay.style.display = "block";
    });

    // Handle recommendation request
    document.getElementById("recommendBtn").addEventListener("click", () => {
      const days = daySelect.value;
      const games = gameSelect.value;
      const likedGameIds = JSON.parse(localStorage.getItem("selectedGameIds") || "[]");

      // Validation
      if (!days || !games) {
        alert("Please select both number of days and number of games.");
        return;
      }

      // Show loading status
      document.getElementById("recommendBtn").textContent = "Loading... ‚åõ";

      // Send request to backend recommender API
      fetch("/api/recommender", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          liked_game_ids: likedGameIds,
          days: parseInt(days),
          games: parseInt(games)
        })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Server response:", data);
        
        // If recommendations found ‚Üí store & redirect
        if (data.recommended_games) {
          console.log("Storing games:", data.recommended_games.length);
          localStorage.setItem("recommendedGames", JSON.stringify(data.recommended_games));
          console.log("Stored. Redirecting now...");
          setTimeout(() => {
            window.location.href = "/show-results";
          }, 1000); // delay ensures storage is written before redirect
        } else {
          alert("No recommendations found.");
        }
      })
      .catch(err => {
        console.error("Error sending recommendation request:", err);
        alert("Failed to get recommendations.");
      });
    });
  </script>
</body>
</html>

